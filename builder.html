<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Purdue IE Â· Schedule Builder</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- SheetJS for parsing Excel files -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg: #f9fff9;
      --panel: #ffffff;
      --text: #1e2a1e;
      --muted: #5f6f5f;
      --primary: #4caf50;
      --ring: #a8d5b9;
      --warn: #b83b3b;
      /* dynamic header height (updated via JS) */
      --header-h: 64px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky;top:0;
      background:linear-gradient(180deg,var(--bg),rgba(255,255,255,0));
      z-index:20;padding:.75rem 1rem;
      border-bottom:1px solid color-mix(in oklab, var(--primary) 20%, #ffffff)
    }
    .container{
      display:grid;
      grid-template-columns:320px 1fr;
      gap:16px;
      padding:16px;
      align-items:start; /* ensures sticky aside sticks within grid */
    }
    .panel{background:var(--panel);border:1px solid color-mix(in oklab, var(--primary) 25%, #ffffff);border-radius:16px;padding:12px}
    h1{font-size:1.25rem;margin:.25rem 0 .5rem 0;color:var(--primary)}
    h2{font-size:1.05rem;margin:.5rem 0;color:color-mix(in oklab, var(--primary) 60%, #1e2a1e)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--primary);background:var(--bg);border-radius:999px;padding:.45rem .75rem;font-weight:600;cursor:pointer;color:var(--primary)}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:white}
    .btn.ghost{background:transparent;color:var(--muted);border:1px solid color-mix(in oklab, var(--primary) 25%, #ffffff)}
    .btn.small{padding:.25rem .5rem;font-size:.85rem}
    .btn:focus{outline:2px solid var(--ring);outline-offset:2px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:.25rem .5rem;border-radius:999px;background:color-mix(in oklab, var(--primary) 15%, #ffffff);border:1px solid color-mix(in oklab, var(--primary) 25%, #ffffff);font-size:.85rem;color:var(--text)}

    .card{background:#ffffff;border:1px solid color-mix(in oklab, var(--primary) 20%, #ffffff);border-radius:12px;padding:.5rem .6rem;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .card[data-locked="true"]{background:color-mix(in oklab, var(--primary) 8%, #ffffff)}
    .card-header{display:flex;gap:8px;align-items:baseline;flex-wrap:wrap}
    .code{font-weight:700;color:var(--primary)}
    .name{color:var(--text)}
    .credits{font-variant-numeric:tabular-nums;background:color-mix(in oklab, var(--primary) 15%, #ffffff);border:1px solid color-mix(in oklab, var(--primary) 30%, #ffffff);border-radius:8px;padding:2px 6px}
    .tools{display:flex;gap:6px}
    .tool{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;border:1px solid color-mix(in oklab, var(--primary) 25%, #ffffff);background:var(--bg);cursor:pointer;color:var(--text)}
    .tool:hover{background:color-mix(in oklab, var(--primary) 15%, #ffffff)}
    .tool[aria-disabled="true"]{opacity:.45;pointer-events:none}

    .pool{display:grid;gap:8px}
    .pool + .pool{margin-top:10px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(240px,1fr));gap:12px}
    .term{display:flex;flex-direction:column;gap:8px}
    .term-head{display:flex;align-items:center;justify-content:space-between}
    .drop{min-height:120px;padding:8px;background:color-mix(in oklab, var(--primary) 10%, #ffffff);border:1px dashed color-mix(in oklab, var(--primary) 40%, #ffffff);border-radius:12px;display:grid;gap:8px}
    .drop.dragover{background:color-mix(in oklab, var(--primary) 20%, #ffffff)}
    .sum{font-weight:600}

    .status{display:grid;gap:8px}
    .ok{color:var(--primary)}
    .bad{color:var(--warn)}
    .muted{color:var(--muted)}

    @media (max-width: 1100px){
      .grid{grid-template-columns:repeat(2,minmax(240px,1fr))}
      .container{grid-template-columns:1fr}
      /* on narrow screens, sticky aside isn't needed */
      aside.panel{position:static;max-height:none;overflow:visible}
    }

    dialog#dlg{border:1px solid color-mix(in oklab, var(--primary) 25%, #ffffff);border-radius:12px;padding:0;max-width:520px}
    dialog#dlg form{padding:12px 12px 0 12px}
    dialog#dlg input[type="text"], dialog#dlg input[type="number"]{width:100%;padding:.6rem;border:1px solid color-mix(in oklab, var(--primary) 25%, #ffffff);border-radius:10px}
    dialog#dlg .row{gap:8px}

    /* ---------- NEW: sticky, self-scrolling left column ---------- */
    aside.panel{
      position: sticky;
      top: calc(var(--header-h) + 8px);
      max-height: calc(100vh - var(--header-h) - 24px);
      overflow:auto;
      padding-right:10px; /* room for scrollbar */
    }

    /* ---------- NEW: compact mode for the left column ---------- */
    aside.panel.compact h2{margin:.25rem 0;font-size:.95rem}
    aside.panel.compact .pool{gap:6px}
    aside.panel.compact .card{padding:.35rem .5rem;border-radius:10px}
    aside.panel.compact .name{display:none}       /* hide long titles */
    aside.panel.compact .credits{padding:1px 4px;border-radius:6px;font-size:.8rem}
    aside.panel.compact .tool{width:24px;height:24px;border-radius:6px}
    aside.panel.compact .tools{gap:4px}
  </style>
</head>
<body>
  <header>
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <h1>Purdue IE Â· Schedule Builder</h1>
        <span class="pill" title="Data saved in your browser">Autosaves</span>
        <span id="lists-status" class="pill" title="Validation lists status">Loading listsâ€¦</span>
      </div>
      <div class="row">
        <!-- NEW: compact toggle lives in the header -->
        <button class="btn small ghost" id="btn-compact" title="Toggle compact left column">Compact pools</button>
        <button class="btn small" id="btn-export" title="Export to Excel (.xlsx). Hold Alt for JSON">Export</button>
        <button class="btn small" id="btn-import" title="Load a plan from JSON">Import</button>
        <button class="btn small ghost" id="btn-reset" title="Start fresh (keeps required courses)">Reset</button>
        <button class="btn primary" id="btn-help">Quick Guide</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Left: Pools -->
    <aside class="panel" aria-label="Course pools" id="left-pools">
      <h2>Required IE (fixed titles)</h2>
      <div id="pool-required-ie" class="pool" aria-live="polite"></div>

      <h2 style="margin-top:12px">Other Required (fixed titles)</h2>
      <div id="pool-other-req" class="pool"></div>

      <div class="panel" style="margin-top:12px;background:color-mix(in oklab, var(--primary) 8%, #ffffff)">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">IE Selectives (6 cr)</h2><br>
          <label class="row" style="gap:6px;font-size:.9rem">
            <input type="radio" name="ieSelMode" value="opt1" checked /> Option I
          </label>
          <label class="row" style="gap:6px;font-size:.9rem">
            <input type="radio" name="ieSelMode" value="opt2" /> Option II
          </label>
        </div>
        <div id="pool-ie-sel" class="pool" style="margin-top:8px"></div>
        <div class="row" style="margin-top:6px">
          <button class="btn small" id="add-ie-sel" title="Add a custom 3-credit IE selective (Option II)">+ IE Selective (3)</button>
        </div>
      </div>

      <div class="panel" style="margin-top:12px;background:color-mix(in oklab, var(--primary) 8%, #ffffff)">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Technical Selectives (9 cr)</h2>
          <button class="btn small" id="add-tech">+ Add Tech Selective</button>
        </div>
        <div id="pool-tech" class="pool" style="margin-top:8px"></div>
      </div>

      <div class="panel" style="margin-top:12px;background:color-mix(in oklab, var(--primary) 8%, #ffffff)">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">General Education (18 cr)</h2>
          <label class="row" style="gap:6px;font-size:.9rem" title="If 6 credits counted in FYE, reduce on-site requirement by 6.">
            <input type="checkbox" id="fye-credit" checked /> Count 6 cr from FYE
          </label>
        </div>
        <div id="pool-gened" class="pool" style="margin-top:8px"></div>
        <div class="row" style="margin-top:6px">
          <button class="btn small" id="add-gened">+ Add Gen Ed</button>
        </div>
        <p class="muted" style="margin:.5rem 0 0 0;font-size:.85rem">Mark non-intro inside the card for at least 6 credits.</p>
      </div>

      <div class="panel" style="margin-top:12px;background:color-mix(in oklab, var(--primary) 8%, #ffffff)">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">In-General Extra Classes (optional)</h2>
          <button class="btn small" id="add-extra">+ Add Extra Class</button>
        </div>
        <div id="pool-extra" class="pool" style="margin-top:8px"></div>
      </div>
    </aside>

    <!-- Right: Terms grid -->
    <section class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Your 8-Semester Plan</h2>
        <div class="row">
          <span class="pill"><strong id="total-credits">0</strong> total credits</span>
          <span class="pill">Per-term target ~ <input id="term-target" type="number" value="15" min="0" max="25" style="width:3.5rem;border:0;background:transparent;text-align:center"> cr</span>
        </div>
      </div>
      <div id="terms" class="grid" style="margin-top:8px"></div>
      <div class="panel" style="margin-top:12px">
        <h2 style="margin:0 0 8px 0">Checkpoints</h2>
        <div id="status" class="status"></div>
      </div>
    </section>
  </main>

  <!-- Edit dialog -->
  <dialog id="dlg">
    <form method="dialog">
      <h2 id="dlg-title" style="margin:12px 12px 8px 12px">Edit</h2>
      <div class="row" style="gap:8px;margin:0 12px 8px 12px">
        <label style="flex:1">
          <div class="muted" style="font-size:.85rem">Title (optional for validated adds)</div>
          <input id="dlg-title-input" type="text" />
        </label>
        <label>
          <div class="muted" style="font-size:.85rem">Credits</div>
          <input id="dlg-credits-input" type="number" min="0" max="18" step="0.5" style="width:6.2rem" />
        </label>
      </div>
      <label class="row" style="gap:8px;margin:0 12px 8px 12px">
        <input id="dlg-nonintro" type="checkbox" /> Count as Non-Intro (Gen Ed)
      </label>
      <div class="row" style="justify-content:flex-end;border-top:1px solid color-mix(in oklab, var(--primary) 25%, #ffffff);padding:10px 12px 12px 12px">
        <button class="btn small ghost" value="cancel">Cancel</button>
        <button class="btn small primary" value="ok">Save</button>
      </div>
    </form>
  </dialog>

  <script>
    // ---------- Config: paths to your Excel allow-lists ----------
    const TECH_XLSX_URL = 'assets/techelectives.xlsx';
    const GEN_XLSX_URL  = 'assets/generalelectives.xlsx';

    // ---------- Enhanced normalization function ----------
    const norm = (s) => {
      const t = String(s ?? '')
        .replace(/[\u00A0\u1680\u180E\u2000-\u200B\u202F\u205F\u3000]/g, ' ')
        .replace(/[^\w\s-]/g, ' ')
        .toUpperCase()
        .trim();
      const patterns = [
        /([A-Z]{2,5})\s*[- ]?(\d{3,5})/,
        /([A-Z]{2,5})\s*[- ]?(\d{3,5})[A-Z]?/,
        /(\d{3,5})[A-Z]?\s+([A-Z]{2,5})/
      ];
      for (const pattern of patterns) {
        const m = t.match(pattern);
        if (m) {
          if (/^\d/.test(m[1])) {
            return `${m[2]} ${m[1]}`;
          } else {
            return `${m[1]} ${m[2]}`;
          }
        }
      }
      return '';
    };

    // ---------- Enhanced XLSX loader ----------
    const allow = { tech: new Set(), gened: new Set() };
    
    async function loadXlsxToSet(url, targetSet){
      try{
        const res = await fetch(url, {cache:'no-store'});
        if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
        const buf = await res.arrayBuffer();
        const wb = XLSX.read(buf, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        if (!ws || !ws['!ref']) return {ok:true};

        const cellAddresses = Object.keys(ws).filter(key => 
          key[0] !== '!' && /^[A-Z]+\d+$/.test(key)
        );

        const cells = cellAddresses.map(addr => {
          const decoded = XLSX.utils.decode_cell(addr);
          return {
            addr,
            row: decoded.r,
            col: decoded.c,
            value: ws[addr]?.v || ws[addr]?.w || ''
          };
        }).sort((a, b) => a.row - b.row || a.col - b.col);

        const foundCodes = new Set();
        const cellsByRow = {};
        const cellsByCol = {};

        for (const cell of cells){
          const normalized = norm(String(cell.value));
          if (normalized) { foundCodes.add(normalized); targetSet.add(normalized); }
          (cellsByRow[cell.row] ||= []).push(cell);
          (cellsByCol[cell.col] ||= []).push(cell);
        }

        for (const rowCells of Object.values(cellsByRow)) {
          rowCells.sort((a,b)=>a.col-b.col);
          for (let i=0;i<rowCells.length-1;i++){
            const A=rowCells[i], B=rowCells[i+1];
            if (B.col - A.col <= 2){
              const va=String(A.value).toUpperCase().trim();
              const vb=String(B.value).toUpperCase().trim();
              if (/^[A-Z]{2,5}$/.test(va) && /^\d{3,5}[A-Z]?$/.test(vb)) {
                const code=`${va} ${vb.replace(/[A-Z]$/,'')}`; foundCodes.add(code); targetSet.add(code);
              }
              if (/^\d{3,5}[A-Z]?$/.test(va) && /^[A-Z]{2,5}$/.test(vb)) {
                const code=`${vb} ${va.replace(/[A-Z]$/,'')}`; foundCodes.add(code); targetSet.add(code);
              }
            }
          }
        }

        for (const colCells of Object.values(cellsByCol)) {
          colCells.sort((a,b)=>a.row-b.row);
          for (let i=0;i<colCells.length-1;i++){
            const A=colCells[i], B=colCells[i+1];
            if (B.row - A.row <= 2){
              const va=String(A.value).toUpperCase().trim();
              const vb=String(B.value).toUpperCase().trim();
              if (/^[A-Z]{2,5}$/.test(va) && /^\d{3,5}[A-Z]?$/.test(vb)) {
                const code=`${va} ${vb.replace(/[A-Z]$/,'')}`; foundCodes.add(code); targetSet.add(code);
              }
              if (/^\d{3,5}[A-Z]?$/.test(va) && /^[A-Z]{2,5}$/.test(vb)) {
                const code=`${vb} ${va.replace(/[A-Z]$/,'')}`; foundCodes.add(code); targetSet.add(code);
              }
            }
          }
        }

        return {ok: true, count: foundCodes.size};

      } catch(err) {
        console.error('Failed loading', url, err);
        return {ok: false, err};
      }
    }

    async function initAllowLists(){
      const badge = document.getElementById('lists-status');
      badge.textContent = 'Loading listsâ€¦';
      const t = await loadXlsxToSet(TECH_XLSX_URL, allow.tech);
      const g = await loadXlsxToSet(GEN_XLSX_URL,  allow.gened);

      if (t.ok && g.ok){
        badge.textContent = 'Validation: ready';
        badge.title = `Tech loaded (${allow.tech.size}); GenEd loaded (${allow.gened.size})`;
      } else if (t.ok || g.ok){
        badge.textContent = 'Validation: partial';
        badge.title = `${t.ok?'Tech OK':'Tech failed'}; ${g.ok?'GenEd OK':'GenEd failed'}`;
      } else {
        badge.textContent = 'Validation: failed';
        badge.title = 'Both lists failed to load â€” check /assets paths or file names';
      }
    }

    // ---------- Data ----------
    const REQUIRED_IE = [
      ["IE 20000","Industrial Engineering Seminar",0],
      ["IE 23000","Probability And Statistics In Engineering I",3],
      ["IE 33000","Probability And Statistics In Engineering II",3],
      ["IE 33200","Computing In Industrial Engineering",3],
      ["IE 33500","Operations Research â€“ Optimization",3],
      ["IE 33600","Operations Research â€“ Stochastic Models",3],
      ["IE 34300","Engineering Economics",3],
      ["IE 37000","Manufacturing Processes I",3],
      ["IE 38300","Integrated Production Systems I",3],
      ["IE 38600","Work Analysis And Design I",3],
      ["IE 43100","Industrial Engineering Design",3],
      ["IE 47400","Industrial Control Systems",3],
      ["IE 48600","Work Analysis And Design II",3],
    ];

    const OTHER_REQ = [
      ["CS 15900","C Programming",3],
      ["MA 26100","Multivariate Calculus",4],
      ["MA 26500","Linear Algebra",3],
      ["MA 26600","Ordinary Differential Equations",3],
      ["ME 27000","Basic Mechanics I",3],
      ["ME 20000","Thermodynamics I",3],
      ["NUCL 27300","Mechanics Of Materials",3],
      ["PHYS 24100","Electricity And Optics",3],
      ["ECE 20001","Electrical Engineering Fundamentals I",3],
    ];

    const IE_SEL_FIXED = [
      ["IE 47000","Manufacturing Processes II",3],
      ["IE 48400","Integrated Production Systems II",3],
    ];

    // ---------- State ----------
    const uid = () => Math.random().toString(36).slice(2,10);

    const state = {
      pools: { requiredIE: [], otherReq: [], ieSel: [], tech: [], gened: [], extra: [] },
      terms: Array.from({length:8}, () => []),
      settings: { ieSelMode: 'opt1', fyeCredit: true, termTarget: 15 }
    };

    function seedInitial(){
      state.pools.requiredIE = REQUIRED_IE.map(([code,name,cr])=>({id:uid(),code,name,credits:cr,cat:'requiredIE',locked:true,nonIntro:false}));
      state.pools.otherReq   = OTHER_REQ.map(([code,name,cr])=>({id:uid(),code,name,credits:cr,cat:'otherReq',locked:true,nonIntro:false}));
      state.pools.ieSel      = IE_SEL_FIXED.map(([code,name,cr])=>({id:uid(),code,name,credits:cr,cat:'ieSel',locked:false,nonIntro:false,fixedIE:true}));
      state.pools.tech = [];
      state.pools.gened = [];
      state.pools.extra = [];
    }

    // ---------- Persistence ----------
    const KEY='ie-schedule-v1';
    function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){ /* ignore quota */ } }
    function load(){
      try{
        const s = JSON.parse(localStorage.getItem(KEY));
        if (s && s.pools && s.terms && s.settings) Object.assign(state, s);
      }catch(e){
        localStorage.removeItem(KEY);
      }
      if (!state.pools.requiredIE?.length) seedInitial();
    }

    // ---------- Rendering ----------
    const elRequired = document.getElementById('pool-required-ie');
    const elOther = document.getElementById('pool-other-req');
    const elIESel = document.getElementById('pool-ie-sel');
    const elTech = document.getElementById('pool-tech');
    const elGen = document.getElementById('pool-gened');
    const elExtra = document.getElementById('pool-extra');
    const elTerms = document.getElementById('terms');
    const elStatus = document.getElementById('status');

    function labelForCat(cat){
      return ({ieSel:'IE Selective', tech:'Tech Selective', gened:'Gen Ed', extra:'Extra'})[cat] || '';
    }

    function courseCard(c){
      const div=document.createElement('div');
      div.className='card';
      div.draggable=true;
      div.id=c.id;
      div.dataset.locked = c.locked ? 'true' : 'false';
      div.dataset.cat = c.cat;
      /* NEW: helpful hover tooltip so compact mode still exposes info */
      div.title = [c.code || labelForCat(c.cat), c.name].filter(Boolean).join(' â€” ');
      div.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', JSON.stringify({id:c.id}));
        e.dataTransfer.effectAllowed='move';
      });

      const head=document.createElement('div'); head.className='card-header';
      const code=document.createElement('span'); code.className='code'; code.textContent=c.code || labelForCat(c.cat);
      const name=document.createElement('span'); name.className='name'; name.textContent=c.name || '';
      const cr=document.createElement('span'); cr.className='credits'; cr.textContent=`${Number(c.credits)} cr`;
      head.append(code,name,cr);

      const tools=document.createElement('div'); tools.className='tools';
      const btnEdit=document.createElement('button'); btnEdit.className='tool'; btnEdit.innerHTML='âœï¸'; btnEdit.title='Edit';
      if(c.locked || c.cat==='requiredIE' || c.cat==='otherReq' || c.fixedIE){ btnEdit.setAttribute('aria-disabled','true'); }
      btnEdit.onclick=()=> openEdit(c);

      const btnX=document.createElement('button'); btnX.className='tool'; btnX.innerHTML='ðŸ—‘ï¸'; btnX.title='Remove to pool';
      btnX.onclick=()=> removeCourse(c.id);

      if(c.cat==='gened'){
        const tog=document.createElement('button'); tog.className='tool'; tog.title='Toggle Non-Intro';
        tog.textContent = c.nonIntro ? 'â˜…' : 'â˜†';
        tog.onclick=()=>{ c.nonIntro=!c.nonIntro; render(); };
        tools.appendChild(tog);
      }

      tools.append(btnEdit,btnX);
      div.append(head,tools);
      return div;
    }

    function renderPools(){
      [elRequired,elOther,elIESel,elTech,elGen,elExtra].forEach(el=> el.innerHTML='');
      state.pools.requiredIE.forEach(c=>elRequired.appendChild(courseCard(c)));
      state.pools.otherReq.forEach(c=>elOther.appendChild(courseCard(c)));
      state.pools.ieSel.forEach(c=>elIESel.appendChild(courseCard(c)));
      state.pools.tech.forEach(c=>elTech.appendChild(courseCard(c)));
      state.pools.gened.forEach(c=>elGen.appendChild(courseCard(c)));
      state.pools.extra.forEach(c=>elExtra.appendChild(courseCard(c)));
    }

    function sumCredits(arr){ return arr.reduce((s,c)=> s + Number(c.credits||0), 0); }

    function renderTerms(){
      elTerms.innerHTML='';
      const target = document.getElementById('term-target');
      target.value = state.settings.termTarget;
      state.terms.forEach((arr,idx)=>{
        const term=document.createElement('div'); term.className='term';
        const head=document.createElement('div'); head.className='term-head';
        const title=document.createElement('div'); title.innerHTML=`<strong>Term ${idx+1}</strong>`;
        const sum=document.createElement('div'); sum.className='sum'; sum.textContent = `${sumCredits(arr)} cr`;
        if(sumCredits(arr) > state.settings.termTarget + 3) sum.style.color='var(--warn)';
        head.append(title,sum);
        const drop=document.createElement('div'); drop.className='drop'; drop.dataset.term=idx;
        drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
        drop.addEventListener('dragleave', ()=> drop.classList.remove('dragover'));
        drop.addEventListener('drop', e=>{
          e.preventDefault(); drop.classList.remove('dragover');
          const data = e.dataTransfer.getData('text/plain');
          if (!data) return;
          const {id} = JSON.parse(data);
          placeIntoTerm(id, idx);
        });
        arr.forEach(c=> drop.appendChild(courseCard(c)));
        term.append(head,drop);
        elTerms.appendChild(term);
      });
    }

    function renderStatus(){
      const div=elStatus; div.innerHTML='';
      const total = state.terms.flat().reduce((s,c)=> s + Number(c.credits||0),0);
      document.getElementById('total-credits').textContent = total;

      const tally = { requiredIE:0, otherReq:0, ieSel:0, tech:0, gened:0, extra:0 };
      for(const c of state.terms.flat()) tally[c.cat] += Number(c.credits||0);

      const needIEReq = 36;
      const ieReqHave = tally.requiredIE;

      const ieSelMode = state.settings.ieSelMode;
      const ieSelNeed = 6;
      const ieSelHave = tally.ieSel;

      const techNeed = 9; const techHave = tally.tech;

      const genBaseNeed = 18 - (state.settings.fyeCredit ? 6 : 0);
      const genHave = tally.gened;
      const genNonIntro = state.terms.flat().filter(c=>c.cat==='gened' && c.nonIntro).reduce((s,c)=> s + Number(c.credits||0),0);

      const has47000 = state.terms.flat().some(c=>c.code==='IE 47000');
      const has48400 = state.terms.flat().some(c=>c.code==='IE 48400');
      const hasCustomIESel = state.terms.flat().some(c=>c.cat==='ieSel' && !c.fixedIE);

      const list=[
        line(ieReqHave>=needIEReq, `Required IE Courses: ${ieReqHave}/${needIEReq} cr`),
        line(
          (ieSelHave>=ieSelNeed) && (
            ieSelMode==='opt1' ? (has47000 && has48400) : ((has47000||has48400) && hasCustomIESel)
          ),
          `IE Selectives (${ieSelMode==='opt1'?'Option I':'Option II'}): ${ieSelHave}/${ieSelNeed} cr` +
          (ieSelMode==='opt1'? ` (must include IE 47000 & IE 48400)` : ` (1 of IE 47000/48400 + 1 custom IE Selective)`)
        ),
        line(techHave>=techNeed, `Technical Selectives: ${techHave}/${techNeed} cr`),
        line(genHave>=genBaseNeed && genNonIntro>=6, `General Education: ${genHave}/${genBaseNeed} cr (â‰¥6 cr non-intro: ${genNonIntro})`),
      ];
      list.forEach(el=>div.appendChild(el));

      if(tally.extra>0){
        const extraNote=document.createElement('div'); extraNote.className='muted';
        extraNote.textContent = `Extra Classes (optional): ${tally.extra} cr added to total workload.`;
        div.appendChild(extraNote);
      }

      const tips=document.createElement('div'); tips.className='muted';
      tips.textContent = 'Created by Alex K. Lee';
      div.appendChild(tips);
    }

    function line(ok, text){
      const p=document.createElement('div'); p.className= ok? 'ok' : 'bad'; p.textContent = (ok? 'âœ“ ' : 'â€¢ ') + text; return p;
    }

    function render(){
      try{
        renderPools();
        renderTerms();
        renderStatus();
        save();
      }catch(e){
        console.error('Render failed', e);
        alert('Unexpected render error (see console).');
      }
    }

    // ---------- Actions ----------
    function findCourseAnywhere(id){
      for(const [k,arr] of Object.entries(state.pools)){
        const i=arr.findIndex(x=>x.id===id); if(i>-1) return {where:'pool', key:k, idx:i};
      }
      for(let t=0;t<state.terms.length;t++){
        const i=state.terms[t].findIndex(x=>x.id===id); if(i>-1) return {where:'term', term:t, idx:i};
      }
      return null;
    }

    function placeIntoTerm(id, termIdx){
      const loc=findCourseAnywhere(id); if(!loc) return;
      let c;
      if(loc.where==='pool'){ c = state.pools[loc.key].splice(loc.idx,1)[0]; }
      else { c = state.terms[loc.term].splice(loc.idx,1)[0]; }
      state.terms[termIdx].push(c);
      render();
    }

    function removeCourse(id){
      const loc=findCourseAnywhere(id); if(!loc) return;
      let c;
      if(loc.where==='term'){
        c = state.terms[loc.term].splice(loc.idx,1)[0];
        state.pools[c.cat].push(c);
      } else {
        const arr = state.pools[loc.key];
        c = arr[loc.idx];
        if(c.locked || c.cat==='requiredIE' || c.cat==='otherReq'){ return; }
        arr.splice(loc.idx,1);
      }
      render();
    }

    function addElective(cat, title, credits, extras={}){
      const c={id:uid(), code:extras.code || '', name:title, credits:Number(credits), cat, locked:false, nonIntro:false, ...extras};
      state.pools[cat].push(c); render();
    }

    // ---------- Edit dialog ----------
    const dlg = document.getElementById('dlg');
    const dlgTitle = document.getElementById('dlg-title');
    const dlgTitleInput = document.getElementById('dlg-title-input');
    const dlgCreditsInput = document.getElementById('dlg-credits-input');
    const dlgNonIntro = document.getElementById('dlg-nonintro');

    function openEdit(course){
      if (course.locked || course.cat==='requiredIE' || course.cat==='otherReq' || course.fixedIE) return;

      dlgTitle.textContent = `Edit ${course.code || labelForCat(course.cat)}`;
      dlgTitleInput.value = course.name || '';
      dlgCreditsInput.value = Number(course.credits || 0);
      dlgNonIntro.checked = !!course.nonIntro;

      dlgNonIntro.parentElement.style.display = (course.cat === 'gened') ? 'flex' : 'none';

      dlg.returnValue = '';
      dlg.showModal();

      dlg.addEventListener('close', function onClose(){
        dlg.removeEventListener('close', onClose);

        if (dlg.returnValue !== 'ok') return;
        const cr = Number(dlgCreditsInput.value);
        if (!isFinite(cr) || cr <= 0 || cr > 18){
          alert('Enter a valid number of credits (0â€“18).');
          return;
        }
        course.name = dlgTitleInput.value.trim();
        course.credits = cr;
        if (course.cat === 'gened') course.nonIntro = dlgNonIntro.checked;
        render();
      }, { once:true });
    }

    // ---------- Prompts for adding ----------
    function promptForCourseCode(label){
      const raw = prompt(`${label}\nEnter course code (e.g., "CS 30700"):`, '');
      if(raw===null) return null;
      const code = norm(raw);
      if(!code || !/^[A-Z]{2,5}\s+\d{3,5}$/.test(code)){
        alert('Please enter a course code like "CS 30700".');
        return null;
      }
      return code;
    }
    function promptForCredits(defaultCr=3){
      const raw = prompt('Enter credits:', String(defaultCr));
      if(raw===null) return null;
      const cr = Number(raw);
      if(!isFinite(cr) || cr<=0 || cr>18){ alert('Enter a valid number of credits.'); return null; }
      return cr;
    }

    // ---------- Events ----------
    document.getElementById('add-tech').onclick=()=>{
      const code = promptForCourseCode('Technical Selective');
      if(code===null) return;
      if(allow.tech.size===0){ alert('Tech electives list not loaded yet. Check file path or reload.'); return; }
      if(!allow.tech.has(code)){ alert(`"${code}" is not in techelectives.xlsx. Cannot add.`); return; }
      const cr = promptForCredits(3); if(cr===null) return;
      addElective('tech', '', cr, {code});
    };

    document.getElementById('add-gened').onclick=()=>{
      const code = promptForCourseCode('General Education');
      if(code===null) return;
      if(allow.gened.size===0){ alert('General electives list not loaded yet. Check file path or reload.'); return; }
      if(!allow.gened.has(code)){ alert(`"${code}" is not in generalelectives.xlsx. Cannot add.`); return; }
      const cr = promptForCredits(3); if(cr===null) return;
      addElective('gened', '', cr, {code});
    };

    document.getElementById('add-ie-sel').onclick=()=>{
      if(state.settings.ieSelMode==='opt2'){
        const code = promptForCourseCode('Custom IE Selective (Option II)') || '';
        const cr = promptForCredits(3); if(cr===null) return;
        addElective('ieSel','',cr,{code, fixedIE:false});
      } else {
        alert('Custom IE Selective is for Option II. Switch the option above to enable.');
      }
    };

    document.getElementById('add-extra').onclick=()=>{
      const code = promptForCourseCode('Extra Class') || '';
      const cr = promptForCredits(3); if(cr===null) return;
      addElective('extra','',cr,{code});
    };

    Array.from(document.getElementsByName('ieSelMode')).forEach(r=>{
      r.addEventListener('change', e=>{ state.settings.ieSelMode = e.target.value; render(); });
    });
    document.getElementById('fye-credit').onchange = (e)=>{ state.settings.fyeCredit = e.target.checked; render(); };
    document.getElementById('term-target').onchange = (e)=>{
      const v = Math.max(0, Math.min(25, Number(e.target.value||15)));
      state.settings.termTarget = v; e.target.value = v; render();
    };

    document.getElementById('btn-reset').onclick=()=>{
      if(confirm('Reset plan? Electives will be cleared; required courses stay in pools.')){
        const keepSettings = {...state.settings};
        state.pools = { requiredIE:[], otherReq:[], ieSel:[], tech:[], gened:[], extra:[] };
        state.terms = Array.from({length:8}, () => []);
        seedInitial();
        state.settings = keepSettings;
        render();
      }
    };

    // ---------- EXPORTS ----------
    function exportJSON(){
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='purdue-ie-plan.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 0);
    }

    function exportExcel(){
      const HEADER = ['Term','Code','Title','Credits','Category','Notes','Grade'];
      const catName = (c) => ({requiredIE:'Required IE', otherReq:'Other Required', ieSel:'IE Selective', tech:'Tech Selective', gened:'Gen Ed', extra:'Extra'}[c.cat] || c.cat);
      const noteFor = (c) => (c.cat==='gened' && c.nonIntro) ? 'Non-Intro' : '';

      // Sort key: department then number; fallback by category & name
      function courseSortKey(c){
        const code = (c.code||'').toUpperCase().trim();
        const m = code.match(/^([A-Z]+)\s+(\d+)/);
        if (m) return [m[1], Number(m[2])||0, (c.name||'').toUpperCase()];
        return [catName(c).toUpperCase(), 99999, (c.name||'').toUpperCase()];
      }

      const aoa = [];
      const stamp = new Date().toLocaleString();

      // Title + info block (blank fields to fill in Excel)
      aoa.push([`Purdue IE 8-Semester Plan â€” exported ${stamp}`]);
      aoa.push(['Student Name:', '', 'Advisor:', '', 'Semester:', '', '']);
      aoa.push(['Catalog Year:', '', 'Major/Concentration:', '', 'Graduation Target:', '', '']);
      aoa.push(['Student plan with advisor grade column and unplaced items']);
      aoa.push([]); // spacer
      aoa.push(HEADER.slice());

      // Terms (sorted within each term)
      let grand = 0;
      for (let t = 0; t < state.terms.length; t++){
        const termNum = t + 1;
        aoa.push([`Term ${termNum}`, '', '', '', '', '', '']); // merge later

        const rows = state.terms[t].slice().sort((a,b)=>{
          const ka = courseSortKey(a), kb = courseSortKey(b);
          if (ka[0] !== kb[0]) return ka[0] < kb[0] ? -1 : 1;
          if (ka[1] !== kb[1]) return ka[1] - kb[1];
          if (ka[2] !== kb[2]) return ka[2] < kb[2] ? -1 : 1;
          return 0;
        });

        let sub = 0;
        for (const c of rows){
          aoa.push([
            termNum,
            c.code || catName(c),
            c.name || '',
            Number(c.credits)||0,
            catName(c),
            noteFor(c),
            '' // Grade blank for advisor
          ]);
          sub += Number(c.credits)||0;
        }

        aoa.push(['', '', `Term ${termNum} subtotal`, sub, '', '', '']);
        aoa.push(['', '', '', '', '', '', '']);
        grand += sub;
      }

      // Grand total (placed)
      aoa.push(['', '', 'Grand total (placed)', grand, '', '', '']);
      aoa.push([]); // spacer

      // Unplaced Pools
      aoa.push(['Unplaced (Pools)']);
      aoa.push(['Items still in Required/Other/IE Selectives/Tech/GenEd/Extra pools']);
      aoa.push([]);
      aoa.push(HEADER.slice());

      const poolOrder = [
        ['requiredIE','Required IE'],
        ['otherReq','Other Required'],
        ['ieSel','IE Selectives'],
        ['tech','Tech Selectives'],
        ['gened','General Education'],
        ['extra','Extra'],
      ];

      let unplacedTotal = 0;
      for (const [key, label] of poolOrder){
        const arr = (state.pools[key] || []).slice().sort((a,b)=>{
          const ka = courseSortKey(a), kb = courseSortKey(b);
          if (ka[0] !== kb[0]) return ka[0] < kb[0] ? -1 : 1;
          if (ka[1] !== kb[1]) return ka[1] - kb[1];
          if (ka[2] !== kb[2]) return ka[2] < kb[2] ? -1 : 1;
          return 0;
        });
        if (!arr.length) continue;

        aoa.push([label, '', '', '', '', '', '']); // merge later
        let sub = 0;
        for (const c of arr){
          aoa.push([
            '', // no term
            c.code || catName(c),
            c.name || '',
            Number(c.credits)||0,
            catName(c),
            noteFor(c),
            ''
          ]);
          sub += Number(c.credits)||0;
        }
        aoa.push(['', '', `${label} subtotal`, sub, '', '', '']);
        aoa.push(['', '', '', '', '', '', '']);
        unplacedTotal += sub;
      }

      if (unplacedTotal === 0){
        aoa.push(['(No unplaced items â€” all courses are scheduled)']);
        aoa.push([]);
      }

      // Build sheet
      const ws = XLSX.utils.aoa_to_sheet(aoa);

      // Column widths
      ws['!cols'] = [
        {wch:6},   // Term
        {wch:12},  // Code
        {wch:48},  // Title
        {wch:9},   // Credits
        {wch:18},  // Category
        {wch:18},  // Notes
        {wch:10},  // Grade
      ];

      // Merge section/title rows to make it scannable
      ws['!merges'] = ws['!merges'] || [];
      const mergeRowAtoG = (r0) => ws['!merges'].push({s:{r:r0,c:0}, e:{r:r0,c:6}});

      // Merge title and blurb rows; leave the info rows with separate fields editable
      mergeRowAtoG(0); // big title
      mergeRowAtoG(3); // blurb

      // Auto-merge any section headers where only column A has text (skip main table headers)
      const rng = XLSX.utils.decode_range(ws['!ref']);
      for (let r = 0; r <= rng.e.r; r++){
        const A = ws[XLSX.utils.encode_cell({r, c:0})];
        const B = ws[XLSX.utils.encode_cell({r, c:1})];
        const C = ws[XLSX.utils.encode_cell({r, c:2})];
        const D = ws[XLSX.utils.encode_cell({r, c:3})];
        const E = ws[XLSX.utils.encode_cell({r, c:4})];
        const F = ws[XLSX.utils.encode_cell({r, c:5})];
        const G = ws[XLSX.utils.encode_cell({r, c:6})];
        const onlyA = A && A.v && !B && !C && !D && !E && !F && !G;
        const isMainHeader = A && (A.v === 'Term' || A.v === 'Student Name:'); // safeguard
        if (onlyA && !isMainHeader){
          mergeRowAtoG(r);
        }
      }

      // Write workbook
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Plan');
      XLSX.writeFile(wb, 'purdue-ie-plan.xlsx');
    }

    // Export button: Excel by default, Alt+Click for JSON backup
    document.getElementById('btn-export').onclick=(e)=>{
      if(e && e.altKey){ exportJSON(); } else { exportExcel(); }
    };

    // ---------- Import ----------
    document.getElementById('btn-import').onclick=()=>{
      const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange=()=>{
        const file=inp.files[0]; if(!file) return;
        file.text().then(txt=>{
          try{
            const s=JSON.parse(txt);
            if (!s || typeof s!=='object' || !s.pools || !s.terms || !s.settings) throw new Error('bad');
            Object.assign(state,s);
            if (!state.pools?.requiredIE) seedInitial();
            render();
          }catch{
            alert('Invalid JSON');
          }
        });
      };
      inp.click();
    };

    document.getElementById('btn-help').onclick=()=>{
      alert(
`How this works

â€¢ Drag any course card into a term.
â€¢ Required IE & Other Required titles/credits are fixed (cannot be edited).
â€¢ IE Selectives: choose Option I (IE 47000 + IE 48400) OR Option II (one of those + one custom IE Selective).
â€¢ Add Technical Selectives and Gen Eds with the + buttons â€” validated against your Excel lists (scans full width of the sheet, e.g., col AA).
â€¢ For Gen Ed, mark â˜† to count as Non-Intro (need â‰¥ 6 credits).
â€¢ Extra Classes are optional and not validated.
â€¢ Progress checks update live below the grid.
â€¢ â€œCompact poolsâ€ in the header shrinks the left column so terms stay in view.
â€¢ Autosaves in your browser. Export â†’ Excel (.xlsx). Hold Alt while clicking Export for JSON backup.
â€¢ Import â†’ load a previously exported JSON.`);
    };

    // ---------- NEW: compact toggle + dynamic sticky offset ----------
    function updateHeaderHeight(){
      const h = document.querySelector('header')?.offsetHeight || 64;
      document.documentElement.style.setProperty('--header-h', h + 'px');
    }
    window.addEventListener('resize', updateHeaderHeight);
    new ResizeObserver(updateHeaderHeight).observe(document.querySelector('header'));
    updateHeaderHeight();

    document.getElementById('btn-compact').onclick = ()=>{
      const asideEl = document.getElementById('left-pools');
      asideEl.classList.toggle('compact');
      document.getElementById('btn-compact').textContent =
        asideEl.classList.contains('compact') ? 'Descriptions' : 'Compact';
    };

    // ---------- Init ----------
    (async function(){
      load();        // restores or seeds if empty
      render();      // render current state
      await initAllowLists(); // then load validation lists
      updateHeaderHeight();   // finalize sticky offset
    })();
  </script>
</body>
</html>
