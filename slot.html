<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fair RNG Slot ¬∑ Alex Lee</title>
  <meta name="description" content="Slot machine with cryptographic randomness and a local leaderboard." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f9fff9;
      --panel: #ffffff;
      --text: #1e2a1e;
      --muted: #5f6f5f;
      --primary: #4caf50;
      --ring: rgba(76,175,80,0.15);
      --border: #dce7dc;
      --digit-size: clamp(28px, 5vw, 48px);
      --digit-gap: 6px;
      --reel-radius: 16px;
      --duration-base: 1400ms;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      background: var(--bg);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 32px 16px;
    }
    .wrap{
      width:min(1100px, 96vw);
      display:grid;
      gap:20px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:20px;
      padding:20px;
    }
    h1{
      margin:0 0 8px;
      font-size: clamp(22px, 3vw, 30px);
      letter-spacing:-0.02em;
    }
    .sub{
      color:var(--muted);
      margin:0 0 10px;
      font-size:14px;
    }

    /* Slot display */
    .slot{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:16px;
    }
    .reels{
      display:flex;
      gap: var(--digit-gap);
      padding: 14px;
      background: #f4fbf4;
      border:1px solid var(--border);
      border-radius: 20px;
      box-shadow: 0 0 0 4px var(--ring) inset;
    }
    .reel{
      width: calc(var(--digit-size) * 0.75);
      height: calc(var(--digit-size) * 1.25); /* viewport shows one digit */
      overflow:hidden;
      border-radius: var(--reel-radius);
      border:1px solid var(--border);
      background:#fff;
      position:relative;
    }
    .strip{
      position:absolute;
      inset:0;
      will-change: transform;
    }
    .digit{
      height: calc(var(--digit-size) * 1.25);
      display:grid;
      place-items:center;
      font-weight:700;
      font-size: var(--digit-size);
      line-height: 1;
    }
    .gloss{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.75), rgba(255,255,255,0) 40%, rgba(0,0,0,0.03) 60%, rgba(255,255,255,0.5));
      pointer-events:none;
    }

    /* Spin animation (infinite scroll until we stop) */
    @keyframes scroll {
      from { transform: translateY(0); }
      to   { transform: translateY(-110%); }
    }
    .spin .strip{
      animation: scroll var(--duration-base) linear infinite;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
    }
    button{
      appearance:none;
      border:none;
      background: var(--primary);
      color:#fff;
      font-weight:700;
      padding:12px 16px;
      border-radius: 12px;
      cursor:pointer;
      transition:.15s transform ease, .15s opacity ease, .15s box-shadow ease;
      box-shadow: 0 0 0 0 rgba(76,175,80,0);
    }
    button:disabled{
      opacity:.6; cursor:not-allowed;
    }
    button:hover:not(:disabled){ transform: translateY(-1px); }
    button:active:not(:disabled){ transform: translateY(0); }

    .result{
      font-size: clamp(18px, 2.6vw, 24px);
      font-weight:700;
      letter-spacing:0.02em;
      margin: 2px 0 0;
    }
    .note{
      color:var(--muted);
      font-size:12px;
    }

    /* Leaderboard */
    .leader{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .leader h2{
      margin:0; font-size: clamp(18px, 2.4vw, 22px);
    }
    .board{
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .row{
      display:grid;
      grid-template-columns: 44px 1fr max-content;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      font-size:15px;
    }
    .row:last-child{ border-bottom:0; }
    .pos{
      width:28px; height:28px; border-radius:8px; display:grid; place-items:center;
      background:#f1f9f1; font-weight:700; color:#1f7f26; border:1px solid #d7ecd7;
    }
    .score{
      font-variant-numeric: tabular-nums lining-nums;
      font-weight:700;
    }
    .when{ color:var(--muted); font-size:12px; }

    /* Name entry */
    .entry{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    input[type="text"]{
      min-width: 220px;
      padding: 12px 12px;
      border-radius: 10px;
      border:1px solid var(--border);
      outline:none;
      font-size:14px;
    }
    input[type="text"]:focus{
      box-shadow: 0 0 0 4px var(--ring);
      border-color: var(--primary);
    }

    .footer{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }
    code{ background:#eef7ee; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>üé∞ Fair-RNG Slot Machine</h1>
      <p class="sub">Generates a uniform random number from <strong>0</strong> to <strong>10,000,000,000</strong> using <strong>Web Crypto</strong>. Then post your result to the leaderboard.</p>

      <div class="slot">
        <div class="reels" id="reels" aria-live="polite" aria-label="slot reels">
          <!-- JS creates 10 reels -->
        </div>
        <div class="controls">
          <button id="spinBtn">Spin</button>
          <div class="result" id="resultLabel" aria-live="polite"></div>
        </div>
        <div class="note">Fairness: randomness from <code>window.crypto.getRandomValues</code> + rejection sampling (no modulo bias).</div>
      </div>
    </section>

    <section class="card leader">
      <h2>üèÜ Leaderboard (Top 10)</h2>
      <div class="entry">
        <input id="nameInput" type="text" placeholder="Your name (post after a spin)" aria-label="Your name" />
        <button id="postBtn" disabled>Post Result</button>
      </div>
      <div class="board" id="board" role="table" aria-label="Leaderboard">
        <!-- rows inserted by JS -->
      </div>
      <div class="footer">
        Stored locally in your browser with <code>localStorage</code>. For a global board across all visitors, wire this page to a small backend or serverless DB later (e.g., Firebase/Firestore, Supabase, or a minimal Cloudflare Worker).
      </div>
    </section>
  </main>

  <script>
    // ===== Utilities: cryptographically secure uniform int [0, maxInclusive] =====
    (function(){
      const MAX = 10_000_000_000; // inclusive
      const reelsEl = document.getElementById('reels');
      const spinBtn = document.getElementById('spinBtn');
      const postBtn = document.getElementById('postBtn');
      const nameInput = document.getElementById('nameInput');
      const resultLabel = document.getElementById('resultLabel');
      const boardEl = document.getElementById('board');

      const LEADER_KEY = 'slotLeaderboardV1';
      let lastScore = null;
      let canPostForThisSpin = false;

      // Build 10 reels (ten digits, leading zeros allowed)
      const REELS = [];
      for (let i = 0; i < 10; i++){
        const reel = document.createElement('div');
        reel.className = 'reel';
        const strip = document.createElement('div');
        strip.className = 'strip';
        // digits 0..9 twice to give scroll headroom
        for (let k = 0; k < 20; k++){
          const d = document.createElement('div');
          d.className = 'digit';
          d.textContent = String(k % 10);
          strip.appendChild(d);
        }
        const gloss = document.createElement('div');
        gloss.className = 'gloss';
        reel.appendChild(strip);
        reel.appendChild(gloss);
        reelsEl.appendChild(reel);
        REELS.push({reel, strip});
      }

      function get64() {
        const a = new Uint32Array(2);
        crypto.getRandomValues(a);
        // Compose 64-bit bigint
        return (BigInt(a[0]) << 32n) | BigInt(a[1]);
      }

      // Uniform int in [0, maxInclusive] using rejection sampling (no bias).
      function secureInt(maxInclusive) {
        const n = BigInt(maxInclusive) + 1n; // size of range
        const TWO64 = 1n << 64n;
        const limit = (TWO64 / n) * n - 1n; // highest acceptable r
        let r;
        do {
          r = get64();
        } while (r > limit);
        const v = r % n;
        const num = Number(v); // safe: n = 1e10+1 << 2^53
        return num;
      }

      function pad10(n) {
        let s = String(n);
        while (s.length < 10) s = '0' + s;
        return s;
      }

      function msDelay(ms){ return new Promise(res => setTimeout(res, ms)); }

      function loadBoard(){
        let data = [];
        try {
          data = JSON.parse(localStorage.getItem(LEADER_KEY) || '[]');
        } catch {}
        return Array.isArray(data) ? data : [];
      }

      function saveBoard(rows){
        localStorage.setItem(LEADER_KEY, JSON.stringify(rows));
      }

      function renderBoard(){
        const rows = loadBoard()
          .sort((a,b) => b.score - a.score || a.when - b.when)
          .slice(0,10);

        boardEl.innerHTML = '';
        rows.forEach((r, idx) => {
          const row = document.createElement('div');
          row.className = 'row';
          row.setAttribute('role','row');

          const pos = document.createElement('div');
          pos.className = 'pos';
          pos.textContent = idx+1;

          const who = document.createElement('div');
          who.innerHTML = `<strong>${escapeHtml(r.name || 'Anonymous')}</strong><div class="when">${formatDate(r.when)}</div>`;

          const score = document.createElement('div');
          score.className = 'score';
          score.textContent = r.score.toLocaleString('en-US');

          row.appendChild(pos);
          row.appendChild(who);
          row.appendChild(score);
          boardEl.appendChild(row);
        });
      }

      function escapeHtml(s){
        return (s || '').replace(/[&<>"']/g, c => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        })[c]);
      }

      function formatDate(t){
        try{
          const d = new Date(t);
          return d.toLocaleString();
        }catch{
          return '';
        }
      }

      async function spin(){
        spinBtn.disabled = true;
        postBtn.disabled = true;
        resultLabel.textContent = '';

        // Start spinning all reels
        REELS.forEach(({reel}) => reel.classList.add('spin'));

        // Generate secure number while animation plays
        const value = secureInt(10_000_000_000); // inclusive
        lastScore = value;
        const s = pad10(value);

        // Let it spin a little, then stop each reel with a nice cascade
        const base = 700;     // base delay before stopping first reel
        const step = 90;      // additional per reel
        for (let i = 0; i < REELS.length; i++){
          const {reel, strip} = REELS[i];
          await msDelay(i === 0 ? base : step); // cascade effect
          // Stop this reel: remove spin class, then snap to final digit
          reel.classList.remove('spin');

          // Compute digit height (actual rendered height)
          const digitEl = strip.children[0];
          const digitH = digitEl.getBoundingClientRect().height;

          const digit = Number(s[i]);
          // We placed 20 digits in strip (two cycles). We want to land so that chosen digit is centered at the window.
          // Position target index within second cycle to ensure we scrolled a bit
          const targetIndex = 10 + digit; // second cycle
          const translateY = -targetIndex * digitH;

          // Smooth stop: animate via transition on transform
          strip.style.transition = 'transform 420ms cubic-bezier(.2,.9,.2,1.0)';
          strip.style.transform = `translateY(${translateY}px)`;
        }

        // Small pause, then reveal result + enable posting
        await msDelay(350);
        resultLabel.textContent = `Your number: ${value.toLocaleString('en-US')}`;
        canPostForThisSpin = true;
        postBtn.disabled = false;
        spinBtn.disabled = false;
      }

      spinBtn.addEventListener('click', () => {
        // Reset transforms & transitions before spin
        REELS.forEach(({strip, reel}) => {
          strip.style.transition = 'none';
          strip.style.transform = 'translateY(0px)';
          // force reflow to apply 'none' before adding spin
          void strip.offsetHeight;
        });
        spin().catch(console.error);
      });

      postBtn.addEventListener('click', () => {
        if (!canPostForThisSpin || lastScore === null) return;
        const name = nameInput.value.trim() || 'Anonymous';
        const rows = loadBoard();
        rows.push({
          name, score: lastScore, when: Date.now()
        });
        // Keep top 10 by score (stable)
        const top = rows.sort((a,b)=> b.score - a.score || a.when - b.when).slice(0,10);
        saveBoard(top);
        renderBoard();
        postBtn.disabled = true;
        canPostForThisSpin = false;
      });

      // First render
      renderBoard();

      // Accessibility: let Enter key post
      nameInput.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' && !postBtn.disabled) postBtn.click();
      });

      // Bonus: persist last typed name locally
      nameInput.value = localStorage.getItem('slotName') || '';
      nameInput.addEventListener('input', ()=> {
        localStorage.setItem('slotName', nameInput.value);
      });

      // Resize safety: if digit height changes (responsive),
      // keep current transforms aligned by re-applying last digit positions after resize.
      let resizeTimer;
      window.addEventListener('resize', ()=>{
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(()=>{
          // no-op unless a result is visible; we could recompute alignment here if desired
        }, 150);
      });
    })();
  </script>
</body>
</html>
