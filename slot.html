<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZA Slots</title>
  <meta name="description" content="Slot machine with cryptographic randomness and a global leaderboard powered by Supabase." />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f9fff9;
      --panel: #ffffff;
      --text: #1e2a1e;
      --muted: #5f6f5f;
      --primary: #4caf50;
      --ring: rgba(76,175,80,0.15);
      --border: #dce7dc;
      --digit-size: clamp(28px, 5vw, 48px);
      --digit-gap: 6px;
      --reel-radius: 16px;
      --duration-base: 1400ms;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      background: var(--bg);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 32px 16px;
    }
    .wrap{ width:min(1100px, 96vw); display:grid; gap:20px; }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:20px;
      padding:20px;
    }
    h1{ margin:0 0 8px; font-size: clamp(22px, 3vw, 30px); letter-spacing:-0.02em; }
    .sub{ color:var(--muted); margin:0 0 10px; font-size:14px; }

    .slot{ display:flex; flex-direction:column; align-items:center; gap:16px; }
    .reels{
      display:flex; gap: var(--digit-gap); padding: 14px;
      background: #f4fbf4; border:1px solid var(--border);
      border-radius: 20px; box-shadow: 0 0 0 4px var(--ring) inset;
    }
    .reel{
      width: calc(var(--digit-size) * 0.75);
      height: calc(var(--digit-size) * 1.25);
      overflow:hidden; border-radius: var(--reel-radius);
      border:1px solid var(--border); background:#fff; position:relative;
    }
    .strip{ position:absolute; inset:0; will-change: transform; }
    .digit{
      height: calc(var(--digit-size) * 1.25);
      display:grid; place-items:center; font-weight:700; font-size: var(--digit-size); line-height: 1;
    }
    .gloss{
      content:""; position:absolute; inset:0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.75), rgba(255,255,255,0) 40%, rgba(0,0,0,0.03) 60%, rgba(255,255,255,0.5));
      pointer-events:none;
    }

    @keyframes scroll { from { transform: translateY(0); } to { transform: translateY(-110%); } }
    .spin .strip{ animation: scroll var(--duration-base) linear infinite; }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; }
    button{
      appearance:none; border:none; background: var(--primary); color:#fff;
      font-weight:700; padding:12px 16px; border-radius: 12px; cursor:pointer;
      transition:.15s transform ease, .15s opacity ease, .15s box-shadow ease;
      box-shadow: 0 0 0 0 rgba(76,175,80,0);
    }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    button:hover:not(:disabled){ transform: translateY(-1px); }
    button:active:not(:disabled){ transform: translateY(0); }

    .result{ font-size: clamp(18px, 2.6vw, 24px); font-weight:700; letter-spacing:0.02em; margin: 2px 0 0; }
    .note{ color:var(--muted); font-size:12px; }

    .leader{ display:grid; grid-template-columns: 1fr; gap:14px; }
    .leader h2{ margin:0; font-size: clamp(18px, 2.4vw, 22px); }
    .board{ border:1px solid var(--border); border-radius: 14px; overflow:hidden; background:#fff; }
    .row{
      display:grid; grid-template-columns: 44px 1fr max-content; gap:10px;
      align-items:center; padding:10px 12px; border-bottom:1px solid var(--border); font-size:15px;
    }
    .row:last-child{ border-bottom:0; }
    .pos{
      width:28px; height:28px; border-radius:8px; display:grid; place-items:center;
      background:#f1f9f1; font-weight:700; color:#1f7f26; border:1px solid #d7ecd7;
    }
    .score{ font-variant-numeric: tabular-nums lining-nums; font-weight:700; }
    .when{ color:var(--muted); font-size:12px; }

    .entry{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="text"]{
      min-width: 220px; padding: 12px 12px; border-radius: 10px; border:1px solid var(--border);
      outline:none; font-size:14px;
    }
    input[type="text"]:focus{ box-shadow: 0 0 0 4px var(--ring); border-color: var(--primary); }
    .footer{ color:var(--muted); font-size:12px; margin-top:6px; }
    code{ background:#eef7ee; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>ZA Slots</h1>
      <p class="sub">Click Spin to get a cool random number!</p>

      <div class="slot">
        <div class="reels" id="reels" aria-live="polite" aria-label="slot reels">
          <!-- JS builds 10 reels -->
        </div>
        <div class="controls">
          <button id="spinBtn">Spin</button>
          <div class="result" id="resultLabel" aria-live="polite"></div>
        </div>
        <div class="note">TRUST its a completely random machines ;D.</div>
      </div>
    </section>

    <section class="card leader">
      <h2>üèÜ Leaderboard (Top 10)</h2>
      <div class="entry">
        <input id="nameInput" type="text" placeholder="Your name (post after a spin)" aria-label="Your name" />
        <button id="postBtn" disabled>Post Result</button>
      </div>
      <div class="board" id="board" role="table" aria-label="Leaderboard">
        <!-- rows inserted by JS -->
      </div>
      <div class="footer">
        Backed by <strong>Supabase</strong>. Public read + insert only; updates/deletes disabled by RLS. Namespace: <code>alex-lee-slot</code>.
      </div>
    </section>
  </main>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <script>
    // ========= CONFIGURE THESE TWO LINES =========
    const SUPABASE_URL = 'https://poinupuimgvisffngasj.supabase.co';      // ‚Üê replace
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvaW51cHVpbWd2aXNmZm5nYXNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2OTY3OTAsImV4cCI6MjA3MjI3Mjc5MH0.v1JLJmaDI5DWnv93LCDrCkJv2ItszxTV4lqIbr_eL20';                 // ‚Üê replace
    // ============================================

    // Namespace key must match your DB RLS policy's site value
    const SITE_KEY = 'alex-lee-slot';

    // ---- DOM
    const reelsEl = document.getElementById('reels');
    const spinBtn = document.getElementById('spinBtn');
    const postBtn = document.getElementById('postBtn');
    const nameInput = document.getElementById('nameInput');
    const resultLabel = document.getElementById('resultLabel');
    const boardEl = document.getElementById('board');

    // ---- Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---- Utils
    function escapeHtml(s){
      return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function formatDate(t){
      try{ return new Date(t).toLocaleString(); }catch{ return ''; }
    }
    function msDelay(ms){ return new Promise(res => setTimeout(res, ms)); }
    function pad10(n){ let s = String(n); while (s.length < 10) s = '0' + s; return s; }

    // ---- Crypto RNG [0, 10_000_000_000] inclusive with rejection sampling
    const MAX = 10_000_000_000;
    function get64() {
      const a = new Uint32Array(2);
      crypto.getRandomValues(a);
      return (BigInt(a[0]) << 32n) | BigInt(a[1]);
    }
    function secureInt(maxInclusive) {
      const n = BigInt(maxInclusive) + 1n;
      const TWO64 = 1n << 64n;
      const limit = (TWO64 / n) * n - 1n;
      let r;
      do { r = get64(); } while (r > limit);
      const v = r % n;
      return Number(v); // safe for n = 1e10+1 (< 2^53)
    }

    // ---- Build reels (10 digits)
    const REELS = [];
    for (let i = 0; i < 10; i++){
      const reel = document.createElement('div');
      reel.className = 'reel';
      const strip = document.createElement('div');
      strip.className = 'strip';
      for (let k = 0; k < 20; k++){
        const d = document.createElement('div');
        d.className = 'digit';
        d.textContent = String(k % 10);
        strip.appendChild(d);
      }
      const gloss = document.createElement('div');
      gloss.className = 'gloss';
      reel.appendChild(strip);
      reel.appendChild(gloss);
      reelsEl.appendChild(reel);
      REELS.push({reel, strip});
    }

    // ---- Leaderboard (Supabase)
    async function renderBoard(){
      const { data, error } = await supabase
        .from('slot_scores')
        .select('name, score, created_at')
        .eq('site', SITE_KEY)
        .order('score', { ascending: false })
        .order('created_at', { ascending: true })
        .limit(10);

      if (error) {
        console.error(error);
        boardEl.innerHTML = `
          <div class="row">
            <div class="pos">!</div>
            <div><strong>Couldn‚Äôt load leaderboard</strong><div class="when">${escapeHtml(error.message)}</div></div>
            <div class="score">‚Äî</div>
          </div>`;
        return;
      }

      boardEl.innerHTML = '';
      data.forEach((r, idx) => {
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div class="pos">${idx+1}</div>
          <div><strong>${escapeHtml(r.name)}</strong><div class="when">${formatDate(r.created_at)}</div></div>
          <div class="score">${Number(r.score).toLocaleString('en-US')}</div>
        `;
        boardEl.appendChild(row);
      });
    }

    // ---- Spin flow
    let canPostForThisSpin = false;
    let lastScore = null;

    async function spin(){
      spinBtn.disabled = true;
      postBtn.disabled = true;
      resultLabel.textContent = '';

      // Reset transforms & start spinning
      REELS.forEach(({strip, reel}) => {
        strip.style.transition = 'none';
        strip.style.transform = 'translateY(0px)';
        void strip.offsetHeight;
        reel.classList.add('spin');
      });

      // Generate value while spinning
      const value = secureInt(MAX);
      lastScore = value;
      const s = pad10(value);

      // Stop reels with cascade
      const base = 700, step = 90;
      for (let i = 0; i < REELS.length; i++){
        const {reel, strip} = REELS[i];
        await msDelay(i === 0 ? base : step);
        reel.classList.remove('spin');

        const digitEl = strip.children[0];
        const digitH = digitEl.getBoundingClientRect().height;

        const digit = Number(s[i]);
        const targetIndex = 10 + digit; // second cycle
        const translateY = -targetIndex * digitH;

        strip.style.transition = 'transform 420ms cubic-bezier(.2,.9,.2,1.0)';
        strip.style.transform = `translateY(${translateY}px)`;
      }

      await msDelay(350);
      resultLabel.textContent = `Your number: ${value.toLocaleString('en-US')}`;
      canPostForThisSpin = true;
      postBtn.disabled = false;
      spinBtn.disabled = false;
    }

    spinBtn.addEventListener('click', () => {
      canPostForThisSpin = false;
      postBtn.disabled = true;
      spin().catch(console.error);
    });

    // Post to Supabase
    postBtn.addEventListener('click', async () => {
      if (!canPostForThisSpin || lastScore == null) return;
      const name = (nameInput.value || '').trim().slice(0, 40) || 'Anonymous';

      const { error } = await supabase.from('slot_scores').insert({
        site: SITE_KEY,
        name,
        score: lastScore
      });

      if (error) {
        alert('Failed to post score: ' + error.message);
        return;
      }

      canPostForThisSpin = false;
      postBtn.disabled = true;
      await renderBoard();
    });

    // First render + persist name locally for convenience
    renderBoard();
    nameInput.value = localStorage.getItem('slotName') || '';
    nameInput.addEventListener('input', ()=> localStorage.setItem('slotName', nameInput.value));
    nameInput.addEventListener('keydown', (e)=> { if (e.key === 'Enter' && !postBtn.disabled) postBtn.click(); });
  </script>
</body>
</html>
